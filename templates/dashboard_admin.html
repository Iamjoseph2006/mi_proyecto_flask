{% extends "base.html" %}
{% block title %}Administrador{% endblock %}
{% block content %}

<!-- MENSAJES FLASH -->
<div class="container mt-3" style="max-width: 400px; margin:auto;">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show py-2" role="alert" style="font-size:0.9rem;">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"
            style="padding:0.5rem;"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}
</div>

<div class="container mt-3">
    <h2 class="section-title text-center">Panel de Administraci√≥n</h2>
    <h3>Bienvenido/a, {{ current_user.nombre }} üëã</h3>

    <!-- M√©tricas -->
    <div class="row text-center mt-4">
        <div class="col-md-3">
            <div class="card p-3 bg-light shadow-sm">
                <h4 class="card-title">Usuarios</h4>
                <p class="fs-4 text-center">
                <h3 class="text-center"><span class="contador-int" data-target="{{ data.usuarios }}">0</span></h3>
                </p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 bg-light shadow-sm">
                <h4 class="card-title">Productos</h4>
                <p class="fs-4">
                <h3 class="text-center"><span class="contador-int" data-target="{{ data.productos }}">0</span></h3>
                </p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 bg-light shadow-sm">
                <h4 class="card-title">Ventas</h4>
                <p class="fs-4">
                <h3 class="text-center"><span class="contador-int" data-target="{{ data.ventas }}">0</span></h3>
                </p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 bg-light shadow-sm">
                <h4 class="card-title">Ingresos</h4>
                <p class="fs-4">
                <h3 class="text-center">$<span class="contador-float" data-target="{{ data.ingresos }}">0</span></h3>
                </p>
            </div>
        </div>
    </div>
    {% set por_pagina = 5 %}

    <!-- ===================== USUARIOS ===================== -->
    {% set pagina_usuarios = request.args.get('pagina_usuarios', 1)|int %}
    {% set inicio_u = (pagina_usuarios - 1) * por_pagina %}
    {% set fin_u = inicio_u + por_pagina %}
    {% set usuarios_paginados = usuarios[inicio_u:fin_u] %}
    {% set total_paginas_usuarios = (usuarios|length // por_pagina) + (1 if usuarios|length % por_pagina > 0 else 0) %}

    <h2 class="section-title mt-4">Usuarios Registrados</h2>
    <table class="table table-striped mt-3">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Correo</th>
                <th>Rol</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for u in usuarios_paginados %}
            <tr>
                <td>{{ u.id_usuario }}</td>
                <td>{{ u.nombre }}</td>
                <td>{{ u.mail }}</td>
                <td>{{ u.rol }}</td>
                <td>
                    <form method="POST" action="{{ url_for('eliminar_usuario', id_usuario=u.id_usuario) }}"
                        style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-danger"
                            onclick="return confirm('¬øInactivar a este usuario?');">üóë Inactivar</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5">No hay usuarios registrados.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Paginaci√≥n Usuarios -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if pagina_usuarios == 1 %}disabled{% endif %}">
                <a class="page-link"
                    href="{{ url_for(request.endpoint, pagina_usuarios=pagina_usuarios-1, pagina_productos=request.args.get('pagina_productos',1), pagina_ventas=request.args.get('pagina_ventas',1)) }}">Anterior</a>
            </li>
            {% for p in range(1, total_paginas_usuarios + 1) %}
            <li class="page-item {% if p == pagina_usuarios %}active{% endif %}">
                <a class="page-link"
                    href="{{ url_for(request.endpoint, pagina_usuarios=p, pagina_productos=request.args.get('pagina_productos',1), pagina_ventas=request.args.get('pagina_ventas',1)) }}">{{
                    p }}</a>
            </li>
            {% endfor %}
            <li class="page-item {% if pagina_usuarios == total_paginas_usuarios %}disabled{% endif %}">
                <a class="page-link"
                    href="{{ url_for(request.endpoint, pagina_usuarios=pagina_usuarios+1, pagina_productos=request.args.get('pagina_productos',1), pagina_ventas=request.args.get('pagina_ventas',1)) }}">Siguiente</a>
            </li>
        </ul>
    </nav>

    <!-- ===================== PRODUCTOS ===================== -->
    {% set pagina_productos = request.args.get('pagina_productos',1)|int %}
    {% set inicio_p = (pagina_productos - 1) * por_pagina %}
    {% set fin_p = inicio_p + por_pagina %}
    {% set productos_paginados = productos[inicio_p:fin_p] %}
    {% set total_paginas_productos = (productos|length // por_pagina) + (1 if productos|length % por_pagina > 0 else 0)
    %}

    <!-- Bot√≥n crear producto -->
    <div class="text-end my-3">
        <a href="{{ url_for('crear_producto') }}" class="btn btn-success">‚ûï Crear Producto</a>
    </div>

    <h2 class="section-title mt-4">Productos en Inventario</h2>
    <table class="table table-striped mt-3">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Categor√≠a</th>
                <th>Cantidad</th>
                <th>Precio</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for p in productos_paginados %}
            <tr>
                <td>{{ p.id_producto }}</td>
                <td>{{ p.nombre }}</td>
                <td>{{ p.categoria }}</td>
                <td>{{ p.cantidad }}</td>
                <td>${{ "%.2f"|format(p.precio) }}</td>
                <td>
                    <a href="{{ url_for('editar_producto', id_producto=p.id_producto) }}"
                        class="btn btn-sm btn-primary">‚úèÔ∏è Editar</a>
                    <form method="POST" action="{{ url_for('eliminar_producto', id_producto=p.id_producto) }}"
                        style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-danger"
                            onclick="return confirm('¬øMarcar este producto como inactivo?');">üóë Inactivar</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6">No hay productos disponibles.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Paginaci√≥n Productos -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if pagina_productos == 1 %}disabled{% endif %}">
                <a class="page-link"
                    href="{{ url_for(request.endpoint, pagina_productos=pagina_productos-1, pagina_usuarios=pagina_usuarios, pagina_ventas=request.args.get('pagina_ventas',1)) }}">Anterior</a>
            </li>
            {% for p in range(1, total_paginas_productos + 1) %}
            <li class="page-item {% if p == pagina_productos %}active{% endif %}">
                <a class="page-link"
                    href="{{ url_for(request.endpoint, pagina_productos=p, pagina_usuarios=pagina_usuarios, pagina_ventas=request.args.get('pagina_ventas',1)) }}">{{
                    p }}</a>
            </li>
            {% endfor %}
            <li class="page-item {% if pagina_productos == total_paginas_productos %}disabled{% endif %}">
                <a class="page-link"
                    href="{{ url_for(request.endpoint, pagina_productos=pagina_productos+1, pagina_usuarios=pagina_usuarios, pagina_ventas=request.args.get('pagina_ventas',1)) }}">Siguiente</a>
            </li>
        </ul>
    </nav>

    <!-- ===================== VENTAS ===================== -->
    {% set pagina_ventas = request.args.get('pagina_ventas',1)|int %}
    {% set inicio_v = (pagina_ventas - 1) * por_pagina %}
    {% set fin_v = inicio_v + por_pagina %}
    {% set ventas_paginadas = ventas[inicio_v:fin_v] %}
    {% set total_paginas_ventas = (ventas|length // por_pagina) + (1 if ventas|length % por_pagina > 0 else 0) %}

    <h2 class="section-title mt-4">Ventas Realizadas</h2>
    <table class="table table-bordered mt-3">
        <thead>
            <tr>
                <th>ID Venta</th>
                <th>Cliente</th>
                <th>Fecha</th>
                <th>Total</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for v in ventas_paginadas %}
            <tr>
                <td>{{ v.id_venta }}</td>
                <td>{{ v.cliente }}</td>
                <td>{{ v.fecha }}</td>
                <td>${{ "%.2f"|format(v.total) }}</td>
                <td>
                    <a href="{{ url_for('detalle_venta', id_venta=v.id_venta) }}" class="btn btn-sm btn-info">üëÅ Ver</a>
                    <form method="POST" action="{{ url_for('eliminar_venta', id_venta=v.id_venta) }}"
                        style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-danger"
                            onclick="return confirm('¬øEliminar esta venta?');">üóë Eliminar</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5">No hay ventas registradas.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Paginaci√≥n Ventas -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if pagina_ventas == 1 %}disabled{% endif %}">
                <a class="page-link"
                    href="{{ url_for(request.endpoint, pagina_ventas=pagina_ventas-1, pagina_productos=pagina_productos, pagina_usuarios=pagina_usuarios) }}">Anterior</a>
            </li>
            {% for p in range(1, total_paginas_ventas + 1) %}
            <li class="page-item {% if p == pagina_ventas %}active{% endif %}">
                <a class="page-link"
                    href="{{ url_for(request.endpoint, pagina_ventas=p, pagina_productos=pagina_productos, pagina_usuarios=pagina_usuarios) }}">{{
                    p }}</a>
            </li>
            {% endfor %}
            <li class="page-item {% if pagina_ventas == total_paginas_ventas %}disabled{% endif %}">
                <a class="page-link"
                    href="{{ url_for(request.endpoint, pagina_ventas=pagina_ventas+1, pagina_productos=pagina_productos, pagina_usuarios=pagina_usuarios) }}">Siguiente</a>
            </li>
        </ul>
    </nav>

</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const countersInt = document.querySelectorAll('.contador-int');
        countersInt.forEach(counter => {
            const target = parseInt(counter.getAttribute('data-target'));
            let count = 0;
            const increment = 1; // suma 1 por paso
            const stepTime = 300; // 300ms entre cada incremento

            const interval = setInterval(() => {
                count += increment;
                if (count >= target) {
                    counter.innerText = target;
                    clearInterval(interval);
                } else {
                    counter.innerText = count;
                }
            }, stepTime);
        });

        const countersFloat = document.querySelectorAll('.contador-float');
        countersFloat.forEach(counter => {
            const target = parseFloat(counter.getAttribute('data-target'));
            let count = 0;
            const steps = 60;  // cantidad de pasos
            const increment = target / steps;
            const stepTime = 25;

            const interval = setInterval(() => {
                count += increment;
                if (count >= target) {
                    counter.innerText = target.toFixed(2);
                    clearInterval(interval);
                } else {
                    counter.innerText = count.toFixed(2);
                }
            }, stepTime);
        });
    });
</script>

{% endblock %}